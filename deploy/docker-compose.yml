services:
  app:
    image: nginx:latest
    depends_on:
      fluent-bit:
        condition: service_started
      #- envoy
    volumes:
      - ./volumes/nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./volumes/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./volumes/nginx/html:/usr/share/nginx/html
    ports:
      - "80:80"
# Временно отключено из-за проблемы с резолвингом имени хоста при инициализации logging driver
    logging:
      # используемый драйвер логгирования
      driver: "fluentd"
      options:
        # куда посылать лог-сообщения, необходимо чтобы адрес
        # совпадал с настройками плагина forward
        fluentd-address: 127.0.0.1:24224
        # теги используются для маршрутизации лог-сообщений, тема
        # маршрутизации будет рассмотрена ниже
        tag: app.logs

  postgres:
    image: postgres:15
    restart: always
    env_file:
      - env/.env.db.secrets
    environment:
      POSTGRES_DB: snapmatch-db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  minio:
    image: minio/minio:latest
    restart: always
    command: server /data --console-address ":9001"
    env_file:
      - env/.env.minio.secrets
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"

  opensearch:
    image: opensearchproject/opensearch:2.11.1
    restart: always
    environment:
      discovery.type: single-node
      plugins.security.disabled: true
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    ports:
      - "9200:9200"
      - "9600:9600"

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.1
    command: start-dev --health-enabled=true --import-realm
    env_file:
      - env/.env.keycloak.secrets
    environment:
      KC_HEALTH_ENABLED: true
    volumes:
      - ./volumes/keycloak/import:/opt/keycloak/data/import
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n' >&3 && grep -q '200 OK' <&3"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  envoy:
    image: envoyproxy/envoy:v1.29.0  # Use the official Envoy proxy image
    volumes:
      - ./volumes/envoy/envoy.yaml:/etc/envoy/envoy.yaml  # Mount your Envoy configuration file
    #      - ./envoy/certs:/etc/envoy/certs  # Mount your TLS certificates
    ports:
      - "9901:9901"
      - "10000:10000"
    depends_on:
      keycloak:
        condition: service_healthy

  fluent-bit:
    image: fluent/fluent-bit:latest
    hostname: fluent-bit
    volumes:
      - ./volumes/fluent-bit-etc/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf
      - ./volumes/fluent-bit-etc/parsers.conf:/fluent-bit/etc/parsers.conf
    env_file:
      - env/.env.opensearch.secrets
    environment:
      - OPENSEARCH_HOST=opensearch
    depends_on:
      - opensearch
    ports:
      - "24224:24224"

volumes:
  postgres_data:
  minio_data:
  opensearch_data:
